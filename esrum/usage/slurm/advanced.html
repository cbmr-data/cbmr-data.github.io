<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="search" title="Search" href="../../search.html" /><link rel="next" title="4.3.3. Using the GPU/hi-MEM node" href="gpu.html" /><link rel="prev" title="4.3.1. Basic Slurm jobs" href="basics.html" />

    <!-- Generated with Sphinx 7.1.2 and Furo 2024.01.29 -->
        <title>4.3.2. Advanced Slurm jobs - Esrum Cluster documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/playback.css?v=2c0b8537" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e2322aab" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Esrum Cluster  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">Esrum Cluster  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">1. Contact</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">2. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guidelines.html">3. Guidelines</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../index.html">4. Using the cluster</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of 4. Using the cluster</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 has-children"><a class="reference internal" href="../access/index.html">4.1. Accessing the cluster</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of 4.1. Accessing the cluster</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../access/access.html">4.1.1. Applying for access</a></li>
<li class="toctree-l3"><a class="reference internal" href="../access/connecting.html">4.1.2. Connecting to the cluster</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../filesystem.html">4.2. Projects, data, and home folders</a></li>
<li class="toctree-l2 current has-children"><a class="reference internal" href="index.html">4.3. Running jobs using Slurm</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of 4.3. Running jobs using Slurm</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="basics.html">4.3.1. Basic Slurm jobs</a></li>
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">4.3.2. Advanced Slurm jobs</a></li>
<li class="toctree-l3"><a class="reference internal" href="gpu.html">4.3.3. Using the GPU/hi-MEM node</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../modules.html">4.4. Environment modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../transfers.html">4.5. Transferring data</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../services/index.html">5. Other services</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of 5. Other services</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../services/rstudio.html">5.1. R, RStudio, and Jupyter Notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../services/containers.html">5.2. Running containerized software</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../services/shiny.html">5.3. Public and private Shiny servers</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tips/index.html">6. Tips and tricks</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of 6. Tips and tricks</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tips/modules.html">6.1. Creating environment modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips/tmux.html">6.2. Persistent sessions with tmux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips/batching_commands.html">6.3. Batching commands outside Slurm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tips/robust_scripts.html">6.4. Writing robust bash scripts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">7. Troubleshooting</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../communications/index.html">8. Communications</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of 8. Communications</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../communications/welcome.html">8.1. Welcome to CBMRs Compute Cluster Esrum!</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../communications/workshops.html">8.2. Workshops and other presentations</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="advanced-slurm-jobs">
<span id="p-usage-slurm-advanced"></span><h1><span class="section-number">4.3.2. </span>Advanced Slurm jobs<a class="headerlink" href="#advanced-slurm-jobs" title="Permalink to this heading">#</a></h1>
<p>The following page describes how to use the <code class="docutils literal notranslate"><span class="pre">srun</span></code> command to run
simple commands on the cluster, how to queue batches of jobs using
<code class="docutils literal notranslate"><span class="pre">sbatch</span></code>, including how to manage these jobs and how to map</p>
<section id="running-commands-using-srun">
<h2><span class="section-number">4.3.2.1. </span>Running commands using srun<a class="headerlink" href="#running-commands-using-srun" title="Permalink to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">srun</span></code> command can be used to queue and execute simple commands on
the compute nodes, and for most part it should feel no different than
running a command without Slurm. Simply prefix your command with
<code class="docutils literal notranslate"><span class="pre">srun</span></code> and the queuing system takes care of running it on the first
available compute node:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>srun<span class="w"> </span>gzip<span class="w"> </span>chr20.fasta
</pre></div>
</div>
<img alt="../../_images/srun_minimal.gif" class="gif" src="../../_images/srun_minimal.gif" />
<p>Except for the <code class="docutils literal notranslate"><span class="pre">srun</span></code> prefix, this is exactly as if you ran the
<code class="docutils literal notranslate"><span class="pre">gzip</span></code> command on the head node. However, if you need to pipe output
to a file or to another command, then you <em>must</em> wrap your commands in a
bash (or similar) script:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>srun<span class="w"> </span>bash<span class="w"> </span>my_script.sh
</pre></div>
</div>
<img alt="../../_images/srun_wrapped.gif" class="gif" src="../../_images/srun_wrapped.gif" />
<p>But at that point you might as well use <code class="docutils literal notranslate"><span class="pre">sbatch</span></code> with the <code class="docutils literal notranslate"><span class="pre">--wait</span></code>
option if simply you want to be able to wait for your script to finish.</p>
<section id="cancelling-srun">
<h3><span class="section-number">4.3.2.1.1. </span>Cancelling srun<a class="headerlink" href="#cancelling-srun" title="Permalink to this heading">#</a></h3>
<p>To cancel a job running with srun, simply press <cite>Ctrl + c</cite> twice within
1 second:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>srun<span class="w"> </span>gzip<span class="w"> </span>chr20.fasta
&lt;ctrl+c&gt;<span class="w"> </span>srun:<span class="w"> </span>interrupt<span class="w"> </span><span class="o">(</span>one<span class="w"> </span>more<span class="w"> </span>within<span class="w"> </span><span class="m">1</span><span class="w"> </span>sec<span class="w"> </span>to<span class="w"> </span>abort<span class="o">)</span>
srun:<span class="w"> </span><span class="nv">StepId</span><span class="o">=</span><span class="m">8717</span>.0<span class="w"> </span>task<span class="w"> </span><span class="m">0</span>:<span class="w"> </span>running
&lt;ctrl+c&gt;<span class="w"> </span>srun:<span class="w"> </span>sending<span class="w"> </span>Ctrl-C<span class="w"> </span>to<span class="w"> </span><span class="nv">StepId</span><span class="o">=</span><span class="m">8717</span>.0
srun:<span class="w"> </span>Job<span class="w"> </span>step<span class="w"> </span>aborted:<span class="w"> </span>Waiting<span class="w"> </span>up<span class="w"> </span>to<span class="w"> </span><span class="m">32</span><span class="w"> </span>seconds<span class="w"> </span><span class="k">for</span><span class="w"> </span>job<span class="w"> </span>step<span class="w"> </span>to<span class="w"> </span>finish.
</pre></div>
</div>
<p>See also the <a class="reference internal" href="basics.html#s-cancelling-jobs"><span class="std std-ref">Cancelling jobs</span></a> section on the
<a class="reference internal" href="basics.html#p-usage-slurm-basics"><span class="std std-ref">Basic Slurm jobs</span></a> page.</p>
</section>
</section>
<section id="monitoring-your-jobs">
<span id="s-job-arrays"></span><h2><span class="section-number">4.3.2.2. </span>Monitoring your jobs<a class="headerlink" href="#monitoring-your-jobs" title="Permalink to this heading">#</a></h2>
<p>Slurm offers a number of ways in which you may monitor your jobs:</p>
<ul>
<li><p>The <code class="docutils literal notranslate"><span class="pre">squeue</span></code> command allows you to list jobs that have not yet
finished (or failed). The recommended use is either <code class="docutils literal notranslate"><span class="pre">squeue</span> <span class="pre">--me</span></code>
to show all your jobs or <code class="docutils literal notranslate"><span class="pre">squeue</span> <span class="pre">--job</span> <span class="pre">${JOB_ID}</span></code>, where
<code class="docutils literal notranslate"><span class="pre">${JOB_ID}</span></code> is the ID of the job whose status you want to inspect.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">sacct</span></code> command allows you list jobs that have finished running
(or failed).</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">--wait</span></code> option makes <code class="docutils literal notranslate"><span class="pre">sbatch</span></code> wait until your job has
completed before returning (similar to how <code class="docutils literal notranslate"><span class="pre">srun</span></code> works). This is
for example useful if you want to queue and wait for jobs in a
script.</p></li>
<li><p>In addition to actively monitoring your jobs, it is possible to
receive email notifications when your jobs are started, finish, fail,
are requeued, or some combination. This is accomplished by using the
<code class="docutils literal notranslate"><span class="pre">--mail-user</span></code> and <code class="docutils literal notranslate"><span class="pre">--mail-type</span></code> options:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sbatch<span class="w"> </span>my_script.sh<span class="w"> </span>--mail-user<span class="o">=</span>abc123@ku.dk<span class="w"> </span>--mail-type<span class="o">=</span>END,FAIL
Submitted<span class="w"> </span>batch<span class="w"> </span>job<span class="w"> </span><span class="m">8503</span>
</pre></div>
</div>
<p>When run like this, you will receive notifications at
<code class="docutils literal notranslate"><span class="pre">abc123&#64;ku.dk</span></code> (remember to use your account KU email address!)
when the job is completed or fails. The possible options are <code class="docutils literal notranslate"><span class="pre">NONE</span></code>
(the default), <code class="docutils literal notranslate"><span class="pre">BEGIN</span></code>, <code class="docutils literal notranslate"><span class="pre">END</span></code>, <code class="docutils literal notranslate"><span class="pre">FAIL</span></code>, <code class="docutils literal notranslate"><span class="pre">REQUEUE</span></code>, <code class="docutils literal notranslate"><span class="pre">ALL</span></code>, or
some combination as shown above.</p>
</li>
</ul>
<section id="monitoring-processes-in-jobs">
<span id="s-monitoring-processes-in-jobs"></span><h3><span class="section-number">4.3.2.2.1. </span>Monitoring processes in jobs<a class="headerlink" href="#monitoring-processes-in-jobs" title="Permalink to this heading">#</a></h3>
<p>In addition to monitoring jobs at a high level, it is possible to
actively monitor the processes running in your jobs via (interactive)
shells running on the same node as the job you wish to monitor. This is
particularly useful to make sure that tasks make efficient use of the
allocated resources.</p>
<p>In these examples we will use the <code class="docutils literal notranslate"><span class="pre">htop</span></code> command to monitor our jobs,
but you can use basic <code class="docutils literal notranslate"><span class="pre">top</span></code>, a <code class="docutils literal notranslate"><span class="pre">bash</span></code> shell, or any other command
you prefer, but see the warning below regarding GPU resources.</p>
<p>The first option for directly monitoring jobs is to request a job on the
same server using the <code class="docutils literal notranslate"><span class="pre">--nodelist</span></code> option to specify the exact node
you wish your job to monitor:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>squeue<span class="w"> </span>--me
JOBID<span class="w"> </span>PARTITION<span class="w">     </span>NAME<span class="w">     </span>USER<span class="w"> </span>ST<span class="w">       </span>TIME<span class="w">  </span>NODES<span class="w"> </span>NODELIST<span class="o">(</span>REASON<span class="o">)</span>
<span class="w"> </span><span class="m">8503</span><span class="w"> </span>standardq<span class="w"> </span>my_scrip<span class="w">   </span>abc123<span class="w">  </span>R<span class="w">       </span><span class="m">0</span>:02<span class="w">      </span><span class="m">1</span><span class="w"> </span>esrumcmpn03fl
$<span class="w"> </span>srun<span class="w"> </span>--pty<span class="w"> </span>--nodelist<span class="w"> </span>esrumcmpn03fl<span class="w"> </span>htop
</pre></div>
</div>
<p>This requests an interactive shell on the node on which our job is
running ( <code class="docutils literal notranslate"><span class="pre">esrumcmpn03fl</span></code>) and starts the <code class="docutils literal notranslate"><span class="pre">htop</span></code> tool. This method
requires that there are free resources on the node, but has the
advantage that it does not impact your job.</p>
<p>Alternatively, you can make use of (overlap) the resources used by the
job you wish to monitor, which means that you can perform your
monitoring even if the node is completely booked. This is done using the
<code class="docutils literal notranslate"><span class="pre">--overlap</span></code> and <code class="docutils literal notranslate"><span class="pre">--jobid</span></code> command-line options:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>squeue<span class="w"> </span>--me
JOBID<span class="w"> </span>PARTITION<span class="w">     </span>NAME<span class="w">     </span>USER<span class="w"> </span>ST<span class="w">       </span>TIME<span class="w">  </span>NODES<span class="w"> </span>NODELIST<span class="o">(</span>REASON<span class="o">)</span>
<span class="w"> </span><span class="m">8503</span><span class="w"> </span>standardq<span class="w"> </span>my_scrip<span class="w">   </span>abc123<span class="w">  </span>R<span class="w">       </span><span class="m">0</span>:02<span class="w">      </span><span class="m">1</span><span class="w"> </span>esrumcmpn03fl
$<span class="w"> </span>srun<span class="w"> </span>--pty<span class="w"> </span>--overlap<span class="w"> </span>--jobid<span class="w"> </span><span class="m">8503</span><span class="w"> </span>htop
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">--jobid</span></code> option takes as its argument the ID of the job we wish
to monitor, which we can obtain using for example the <code class="docutils literal notranslate"><span class="pre">squeue</span> <span class="pre">--me</span></code>
command (from the <code class="docutils literal notranslate"><span class="pre">JOBID</span></code> column).</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is not possible to use <code class="docutils literal notranslate"><span class="pre">--overlap</span></code> when you have reserved GPUs
using the <code class="docutils literal notranslate"><span class="pre">--gres</span></code> option. This also means that you cannot monitor
GPU resource usage in this manner, as other jobs on the same node
cannot access already reserved GPUs. See the
<a class="reference internal" href="gpu.html#s-monitoring-gpu-utilization"><span class="std std-ref">Monitoring GPU utilization</span></a> section for instructions on how
to monitor GPU utilization.</p>
</div>
</section>
</section>
<section id="running-multiple-tasks-using-arrays">
<h2><span class="section-number">4.3.2.3. </span>Running multiple tasks using arrays<a class="headerlink" href="#running-multiple-tasks-using-arrays" title="Permalink to this heading">#</a></h2>
<p>As suggested by the name, the <code class="docutils literal notranslate"><span class="pre">sbatch</span></code> command is able to run jobs in
batches. This is accomplished using &quot;job arrays&quot;, which allows you to
automatically queue and run the same command on multiple inputs.</p>
<p>For example, we could expand on the example above to gzip multiple
chromosomes using a job array. To do so, we first need to update the
script to make use of the <code class="docutils literal notranslate"><span class="pre">SLURM_ARRAY_TASK_ID</span></code> variable, which
specifies the numerical ID of a task:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#SBATCH --cpus-per-task=8</span>
<span class="c1">#SBATCH --time=60</span>
<span class="c1">#SBATCH --array=1-3</span>

module<span class="w"> </span>load<span class="w"> </span>igzip/2.30.0
igzip<span class="w"> </span>--threads<span class="w"> </span><span class="si">${</span><span class="nv">SLURM_CPUS_PER_TASK</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;chr</span><span class="si">${</span><span class="nv">SLURM_ARRAY_TASK_ID</span><span class="si">}</span><span class="s2">.fasta&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">--array=1-3</span></code> option specifies that we want to run tasks 1, 2, and
3, each of which is assigned 8 CPUs and each of which is given 60
minutes to run.</p>
<p>See the <code class="docutils literal notranslate"><span class="pre">sbatch</span></code> manual page for a description of ways in which to
specify lists or ranges of task IDs. Values used with <code class="docutils literal notranslate"><span class="pre">--array</span></code> must
be in the range 0 to 1000.</p>
<p>Our script can then be run as before:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ls
chr1.fasta<span class="w"> </span>chr2.fasta<span class="w"> </span>chr3.fasta<span class="w"> </span>my_script.sh
$<span class="w"> </span>sbatch<span class="w"> </span>my_script.sh
Submitted<span class="w"> </span>batch<span class="w"> </span>job<span class="w"> </span><span class="m">8504</span>
$<span class="w"> </span>squeue<span class="w"> </span>--me
<span class="w"> </span>JOBID<span class="w"> </span>PARTITION<span class="w">     </span>NAME<span class="w">     </span>USER<span class="w"> </span>ST<span class="w">       </span>TIME<span class="w">  </span>NODES<span class="w"> </span>NODELIST<span class="o">(</span>REASON<span class="o">)</span>
8504_1<span class="w"> </span>standardq<span class="w"> </span>my_scrip<span class="w">   </span>zlc187<span class="w">  </span>R<span class="w">       </span><span class="m">0</span>:02<span class="w">      </span><span class="m">1</span><span class="w"> </span>esrumcmpn01fl
8504_2<span class="w"> </span>standardq<span class="w"> </span>my_scrip<span class="w">   </span>zlc187<span class="w">  </span>R<span class="w">       </span><span class="m">0</span>:02<span class="w">      </span><span class="m">1</span><span class="w"> </span>esrumcmpn01fl
8504_3<span class="w"> </span>standardq<span class="w"> </span>my_scrip<span class="w">   </span>zlc187<span class="w">  </span>R<span class="w">       </span><span class="m">0</span>:02<span class="w">      </span><span class="m">1</span><span class="w"> </span>esrumcmpn01fl
$<span class="w"> </span>ls
chr1.fasta.gz<span class="w">  </span>chr3.fasta.gz<span class="w">  </span>slurm-8507_1.out<span class="w">  </span>slurm-8507_3.out
chr2.fasta.gz<span class="w">  </span>my_script.sh<span class="w">   </span>slurm-8507_2.out
</pre></div>
</div>
<p>An <code class="docutils literal notranslate"><span class="pre">.out</span></code> file is automatically created for each task.</p>
<p>In this example there was a simple one-to-one mapping between the
<code class="docutils literal notranslate"><span class="pre">SLURM_ARRAY_TASK_ID</span></code> and our data, but that is not always the case.
The <a class="reference internal" href="#mapping-task-ids-to-data">Mapping task IDs to data</a> section below describes several ways you
might use to map the <code class="docutils literal notranslate"><span class="pre">SLURM_ARRAY_TASK_ID</span></code> variable to more complex
data/filenames.</p>
<section id="limiting-simultaneous-jobs">
<h3><span class="section-number">4.3.2.3.1. </span>Limiting simultaneous jobs<a class="headerlink" href="#limiting-simultaneous-jobs" title="Permalink to this heading">#</a></h3>
<p>By default Slurm will attempt to run every job in an array at the same
time, provided that there are resources available. Since Esrum is a
shared resource we ask that you consider how much of the cluster you'll
be using and limit the number of simultaneous jobs.</p>
<p>Limiting the number of simultaneous jobs is done by appending a <code class="docutils literal notranslate"><span class="pre">%</span></code>
and a number at the end of the <code class="docutils literal notranslate"><span class="pre">--array</span></code> value. For example, in the
following script we queue a job array containing 100 jobs, each
requesting 8 CPUs. However, the <code class="docutils literal notranslate"><span class="pre">%16</span></code> appended to the <code class="docutils literal notranslate"><span class="pre">--array</span></code>
ensures that at most 16 of these jobs are running at the same time:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#SBATCH --cpus-per-task=8</span>
<span class="c1">#SBATCH --array=1-100%16</span>
</pre></div>
</div>
<p>This ensures that we use no more than 1 compute node's worth of CPUs
(128 CPUs per node) and thereby leave plenty of capacity available for
other users.</p>
<p>In addition to limiting the number of simultaneously running jobs, you
can also give your jobs a lower priority using the <code class="docutils literal notranslate"><span class="pre">--nice</span></code> option:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#SBATCH --nice</span>
</pre></div>
</div>
<p>This ensures that other users' jobs, if any, will be run before jobs in
your array and thereby prevent your job array from always using the
maximum number of resources possible. Combined with a reasonable <code class="docutils literal notranslate"><span class="pre">%</span></code>
limit this allows you to run more jobs simultaneously, than if you just
used a <code class="docutils literal notranslate"><span class="pre">%</span></code> limit, without negatively impacting other users.</p>
<p>Please reach out if you are running a large number of (job array) jobs
and are in doubt about how many to run at the same time.</p>
</section>
<section id="managing-job-arrays">
<h3><span class="section-number">4.3.2.3.2. </span>Managing job arrays<a class="headerlink" href="#managing-job-arrays" title="Permalink to this heading">#</a></h3>
<p>Job arrays can either be cancelled as a whole or in part. To cancel the
entire job (all tasks in the array) simply use the primary job ID before
the underscore/dot:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>scancel<span class="w"> </span><span class="m">8504</span>
</pre></div>
</div>
<p>To cancel part of a batch job/array, instead specify the ID of the
sub-task after the ID of the batch job, using a dot (<code class="docutils literal notranslate"><span class="pre">.</span></code>) to separate
the two IDs instead of an underscore (<code class="docutils literal notranslate"><span class="pre">_</span></code>):</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>scancel<span class="w"> </span><span class="m">8504</span>.1
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>While it is possible to use <code class="docutils literal notranslate"><span class="pre">sbatch</span></code> with jobs of any size, it
should be remembered that Slurm imposes some overhead on jobs. It is
therefore preferable to run jobs consisting of a large number of
tasks in batches, instead of running each task individually.</p>
</div>
</section>
<section id="mapping-task-ids-to-data">
<h3><span class="section-number">4.3.2.3.3. </span>Mapping task IDs to data<a class="headerlink" href="#mapping-task-ids-to-data" title="Permalink to this heading">#</a></h3>
<p>Using <code class="docutils literal notranslate"><span class="pre">sbatch</span></code> arrays requires that you map a number (the array task
ID) to a filename or similar. The above example assumed that filenames
were numbered, but that is not always the case.</p>
<p>The following describes a few ways in which you can map array task ID to
filenames in a bash script.</p>
<ol class="arabic">
<li><p>Using numbered filenames:</p>
<p>The example showed how to handle filenames where the numbers were
simply written as 1, 2, etc:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simple numbering: sample1.vcf, sample2.vcf, etc.</span>
<span class="nv">FILENAME</span><span class="o">=</span><span class="s2">&quot;sample</span><span class="si">${</span><span class="nv">SLURM_ARRAY_TASK_ID</span><span class="si">}</span><span class="s2">.vcf&quot;</span>
</pre></div>
</div>
<p>However, it is also possible to format numbers in a more complicated
manner (e.g. 001, 002, etc.), using for example the printf command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Formatted numbering: sample001.vcf, sample002.vcf, etc.</span>
<span class="nv">FILENAME</span><span class="o">=</span><span class="k">$(</span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;sample%03i.vcf&quot;</span><span class="w"> </span><span class="si">${</span><span class="nv">SLURM_ARRAY_TASK_ID</span><span class="si">}</span><span class="k">)</span>
</pre></div>
</div>
<p>See above for an example script and the expected output.</p>
</li>
<li><p>Using a table of filenames:</p>
<p>Given a text file <code class="docutils literal notranslate"><span class="pre">my_samples.txt</span></code> containing one filename per
line:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">/path/to/first_sample.vcf</span>
<span class="go">/path/to/second_sample.vcf</span>
<span class="go">/path/to/third_sample.vcf</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prints the Nth line</span>
<span class="nv">FILENAME</span><span class="o">=</span><span class="k">$(</span>sed<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SLURM_ARRAY_TASK_ID</span><span class="si">}</span><span class="s2">q;d&quot;</span><span class="w"> </span>my_samples.txt<span class="k">)</span>
</pre></div>
</div>
<p>A sbatch script could look as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#SBATCH --array=1-3</span>

<span class="nv">FILENAME</span><span class="o">=</span><span class="k">$(</span>sed<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SLURM_ARRAY_TASK_ID</span><span class="si">}</span><span class="s2">q;d&quot;</span><span class="w"> </span>my_samples.txt<span class="k">)</span>

module<span class="w"> </span>load<span class="w"> </span>htslib/1.18
bgzip<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">FILENAME</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</li>
<li><p>Using a table of numbered samples (<code class="docutils literal notranslate"><span class="pre">my_samples.tsv</span></code>):</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>ID</p></td>
<td><p>Name</p></td>
<td><p>Path</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>first</p></td>
<td><p>/path/to/first_sample.vcf</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>second</p></td>
<td><p>/path/to/second_sample.vcf</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>third</p></td>
<td><p>/path/to/third_sample.vcf</p></td>
</tr>
</tbody>
</table>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find row where 1. column matches SLURM_ARRAY_TASK_ID and print 3. column</span>
<span class="nv">FILENAME</span><span class="o">=</span><span class="k">$(</span>awk<span class="w"> </span>-v<span class="w"> </span><span class="nv">ID</span><span class="o">=</span><span class="si">${</span><span class="nv">SLURM_ARRAY_TASK_ID</span><span class="si">}</span><span class="w"> </span><span class="s1">&#39;$1 == ID {print $3; exit}&#39;</span><span class="w"> </span>my_samples.tsv<span class="k">)</span>
</pre></div>
</div>
<p>By default <code class="docutils literal notranslate"><span class="pre">awk</span></code> will split columns by any whitespace, but if you
have a tab separated file (<code class="docutils literal notranslate"><span class="pre">.tsv</span></code>) file it is worthwhile to specify
this using the <code class="docutils literal notranslate"><span class="pre">FS</span></code> (field separator) option:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find row where 1. column matches SLURM_ARRAY_TASK_ID and print 3. column</span>
<span class="nv">FILENAME</span><span class="o">=</span><span class="k">$(</span>awk<span class="w"> </span>-v<span class="w"> </span><span class="nv">FS</span><span class="o">=</span><span class="s2">&quot;\t&quot;</span><span class="w"> </span>-v<span class="w"> </span><span class="nv">ID</span><span class="o">=</span><span class="si">${</span><span class="nv">SLURM_ARRAY_TASK_ID</span><span class="si">}</span><span class="w"> </span><span class="s1">&#39;$1 == ID {print $3; exit}&#39;</span><span class="w"> </span>my_samples.tsv<span class="k">)</span>
</pre></div>
</div>
<p>This ensures that <code class="docutils literal notranslate"><span class="pre">awk</span></code> returns the correct cell even if other
cells contain whitespace.</p>
<p>A sbatch script could look as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#SBATCH --array=1-3</span>

<span class="c1"># Grab second column where the first column equals SLURM_ARRAY_TASK_ID</span>
<span class="nv">NAME</span><span class="o">=</span><span class="k">$(</span>awk<span class="w"> </span>-v<span class="w"> </span><span class="nv">FS</span><span class="o">=</span><span class="s2">&quot;\t&quot;</span><span class="w"> </span>-v<span class="w"> </span><span class="nv">ID</span><span class="o">=</span><span class="si">${</span><span class="nv">SLURM_ARRAY_TASK_ID</span><span class="si">}</span><span class="w"> </span><span class="s1">&#39;$1 == ID {print $2; exit}&#39;</span><span class="w"> </span>my_samples.tsv<span class="k">)</span>
<span class="c1"># Grab third column where the first column equals SLURM_ARRAY_TASK_ID</span>
<span class="nv">FILENAME</span><span class="o">=</span><span class="k">$(</span>awk<span class="w"> </span>-v<span class="w"> </span><span class="nv">FS</span><span class="o">=</span><span class="s2">&quot;\t&quot;</span><span class="w"> </span>-v<span class="w"> </span><span class="nv">ID</span><span class="o">=</span><span class="si">${</span><span class="nv">SLURM_ARRAY_TASK_ID</span><span class="si">}</span><span class="w"> </span><span class="s1">&#39;$1 == ID {print $3; exit}&#39;</span><span class="w"> </span>my_samples.tsv<span class="k">)</span>

module<span class="w"> </span>load<span class="w"> </span>htslib/1.18
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Now processing sample &#39;</span><span class="si">${</span><span class="nv">NAME</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
bgzip<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">FILENAME</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="additional-resources">
<h2><span class="section-number">4.3.2.4. </span>Additional resources<a class="headerlink" href="#additional-resources" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Slurm <a class="reference external" href="https://slurm.schedmd.com/overview.html">documentation</a></p></li>
<li><p>Slurm <a class="reference external" href="https://slurm.schedmd.com/pdfs/summary.pdf">summary</a> (PDF)</p></li>
<li><p>The <a class="reference external" href="https://slurm.schedmd.com/sbatch.html">sbatch manual page</a></p></li>
<li><p>The <a class="reference external" href="https://slurm.schedmd.com/squeue.html">squeue manual page</a></p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="gpu.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title"><span class="section-number">4.3.3. </span>Using the GPU/hi-MEM node</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="basics.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title"><span class="section-number">4.3.1. </span>Basic Slurm jobs</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023-2024, CBMR Data Analytics
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">4.3.2. Advanced Slurm jobs</a><ul>
<li><a class="reference internal" href="#running-commands-using-srun">4.3.2.1. Running commands using srun</a><ul>
<li><a class="reference internal" href="#cancelling-srun">4.3.2.1.1. Cancelling srun</a></li>
</ul>
</li>
<li><a class="reference internal" href="#monitoring-your-jobs">4.3.2.2. Monitoring your jobs</a><ul>
<li><a class="reference internal" href="#monitoring-processes-in-jobs">4.3.2.2.1. Monitoring processes in jobs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#running-multiple-tasks-using-arrays">4.3.2.3. Running multiple tasks using arrays</a><ul>
<li><a class="reference internal" href="#limiting-simultaneous-jobs">4.3.2.3.1. Limiting simultaneous jobs</a></li>
<li><a class="reference internal" href="#managing-job-arrays">4.3.2.3.2. Managing job arrays</a></li>
<li><a class="reference internal" href="#mapping-task-ids-to-data">4.3.2.3.3. Mapping task IDs to data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#additional-resources">4.3.2.4. Additional resources</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../../_static/js/custom.js?v=7a324050"></script>
    <script src="../../_static/js/libgif.js?v=7adcb026"></script>
    <script src="../../_static/js/playback.js?v=c0a59f95"></script>
    </body>
</html>