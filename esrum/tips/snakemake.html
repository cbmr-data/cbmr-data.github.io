<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="search" title="Search" href="../search.html" /><link rel="next" title="Welcome email" href="../communications/messages.html" /><link rel="prev" title="Writing robust bash scripts" href="robust_scripts.html" />

    <!-- Generated with Sphinx 7.1.2 and Furo 2024.01.29 -->
        <title>Using Snakemake on Esrum - Esrum Cluster documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../_static/css/playback.css?v=2c0b8537" />
    <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e2322aab" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Esrum Cluster  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">Esrum Cluster  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">Contact Us</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview of cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guidelines.html">Guidelines and policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using the cluster</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../usage/access/access.html">Applying for access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/access/connecting.html">Connecting to the cluster</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../usage/filesystem.html">Data storage on Esrum</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Data storage on Esrum</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../usage/projects.html">Creating projects and datasets</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../usage/slurm/index.html">Running jobs using Slurm</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Running jobs using Slurm</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../usage/slurm/basics.html">Basic Slurm jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/slurm/advanced.html">Advanced Slurm jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/slurm/gpu.html">Using the GPU / high-memory nodes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../usage/modules.html">Software on Esrum</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/transfers.html">Transferring data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../resources/cohorts.html">Human Cohorts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other services</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../services/r.html">R and RStudio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/jupyter.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/containers.html">Containerized software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/shiny.html">Shiny servers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tips and tricks</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="modules.html">Creating environment modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="tmux.html">Persistent sessions with tmux</a></li>
<li class="toctree-l1"><a class="reference internal" href="batching_commands.html">Batching commands in bash</a></li>
<li class="toctree-l1"><a class="reference internal" href="robust_scripts.html">Writing robust bash scripts</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Using Snakemake on Esrum</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Outreach</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../communications/messages.html">Welcome email</a></li>
<li class="toctree-l1"><a class="reference internal" href="../communications/presentations.html">Presentations</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/cbmr-data/cbmr-data.github.io/edit/main/esrum/source/tips/snakemake.rst" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="using-snakemake-on-esrum">
<span id="p-tips-snakemake"></span><h1>Using Snakemake on Esrum<a class="headerlink" href="#using-snakemake-on-esrum" title="Permalink to this heading">#</a></h1>
<p>This page describes how to best use Snakemake on the Esrum cluster. As
this includes a number of suggested settings (described below), a basic
profile file is provided below to automatically set these.</p>
<p>Snakemake can either be run directly, where all rules (<em>i.e.</em> tasks) are
run on the same system as Snakemake itself, or Snakemake can be
configured to use Slurm to run the individual rules, allowing these to
be run on any compute node on Esrum. The choice between the two options
boils down to the following considerations:</p>
<ul class="simple">
<li><p>If the steps in your Snakemake pipeline are very short, then you
should run your pipeline <em>in</em> a regular <code class="docutils literal notranslate"><span class="pre">sbatch</span></code> script, via
<code class="docutils literal notranslate"><span class="pre">srun</span></code>, or <em>in</em> an interactive session. This is because Slurm adds
some overhead to jobs, which for very short rules may result in a
significant increase in the total runtime.</p></li>
<li><p>If your steps run for a longer time or take up significant amount of
resources, then you should enable Slurm support when running your
pipeline. This ensures that you only reserve resources for your rules
<em>while</em> they are running and enables you to run more rules
simultaneously than can fit on one compute node.</p></li>
<li><p>If any of your rules make use of GPUs, then you <em>must</em> enable Slurm
support when running Snakemake. This ensures that GPUs are <em>only</em>
reserved while they are actively being used, which we require since
GPUs are a very limited resource on Esrum. See below for how to
reserve GPUs for your rules.</p></li>
</ul>
<p>For most bioinformatics pipelines, the most efficient choice is to run
Snakemake with Slurm support enabled.</p>
<section id="running-snakemake-with-slurm-support">
<h2>Running Snakemake with Slurm support<a class="headerlink" href="#running-snakemake-with-slurm-support" title="Permalink to this heading">#</a></h2>
<p>To run Snakemake with Slurm support enabled, simply pass the options
<code class="docutils literal notranslate"><span class="pre">--slurm</span></code> and <code class="docutils literal notranslate"><span class="pre">--jobs</span> <span class="pre">N</span></code>, where the <code class="docutils literal notranslate"><span class="pre">N</span></code> is the maximum number of
jobs you want to queue simultaneously. For example,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>module<span class="w"> </span>load<span class="w"> </span>snakemake/7.30.1
<span class="gp">$ </span>snakemake<span class="w"> </span>--slurm<span class="w"> </span>--jobs<span class="w"> </span><span class="m">32</span>
</pre></div>
</div>
<p>This command will run your pipeline via Slurm and queue at most 32 jobs
at once. Note that we do not need to specify the maximum number of CPUs
(via <code class="docutils literal notranslate"><span class="pre">--cores</span></code>), since Slurm will take care that (see below).</p>
<p>Note also that you <em>must</em> run Snakemake on the head node when using the
<code class="docutils literal notranslate"><span class="pre">--slurm</span></code> option. This is required for Snakemake to be able to
interact with Slurm. Furthermore, you <em>should</em> be running it a <code class="docutils literal notranslate"><span class="pre">tmux</span></code>
or <code class="docutils literal notranslate"><span class="pre">screen</span></code> session to ensure that Snakemake keeps running after you
log out. See the <a class="reference internal" href="tmux.html#p-tips-tmux"><span class="std std-ref">Persistent sessions with tmux</span></a> page for more information.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some older tutorials may suggest setting Slurm options via the
<code class="docutils literal notranslate"><span class="pre">--cluster</span></code> option. However, with modern versions of Snakemake it
is sufficient to add <code class="docutils literal notranslate"><span class="pre">--slurm</span></code> when running Snakemake and that is
the method we recommend using.</p>
</div>
<section id="requesting-cpus">
<h3>Requesting CPUs<a class="headerlink" href="#requesting-cpus" title="Permalink to this heading">#</a></h3>
<p>Snakemake will automatically request a number of CPUs corresponding to
the number of threads used by a rule:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="n">my_rule</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span> <span class="o">...</span>
    <span class="n">output</span><span class="p">:</span> <span class="o">...</span>
    <span class="n">threads</span><span class="p">:</span> <span class="mi">8</span>
</pre></div>
</div>
<p>Snakemake will in other words reserve 8 CPUs for the above rule when
submitting it through Slurm.</p>
</section>
<section id="requesting-memory">
<h3>Requesting memory<a class="headerlink" href="#requesting-memory" title="Permalink to this heading">#</a></h3>
<p>Snakemake will by default estimate the amount of memory needed for a
rule based on the size of the input data (<code class="docutils literal notranslate"><span class="pre">max(2*input.size_mb,</span>
<span class="pre">1000)</span></code>), which translates to two times the size of the input but no
less than 1000 MB.</p>
<p>This is, however, frequently less than the Slurm default of ~16 GB per
CPU reserved, and we therefore recommend overriding this default using
the <code class="docutils literal notranslate"><span class="pre">--default-resources</span></code> option:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>snakemake<span class="w"> </span>--default-resources<span class="w"> </span><span class="nv">mem_mb_per_cpu</span><span class="o">=</span><span class="m">15948</span>
</pre></div>
</div>
<p>This corresponds to the behavior of <code class="docutils literal notranslate"><span class="pre">sbatch</span></code> and <code class="docutils literal notranslate"><span class="pre">srun</span></code>.</p>
<p>Should a job require more memory than the default ~16 GB per CPU, then
you can request additional memory using the <code class="docutils literal notranslate"><span class="pre">resources</span></code> section of
your rule:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="n">my_rule</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span> <span class="o">...</span>
    <span class="n">output</span><span class="p">:</span> <span class="o">...</span>
    <span class="n">resources</span><span class="p">:</span>
        <span class="n">mem_mb</span><span class="p">:</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">mem_mb</span></code> specifies a <em>total</em> amount of memory to reserve in MB and
the above example therefore requests 64 GB for this specific rule.</p>
</section>
<section id="using-the-gpu-high-memory-nodes">
<h3>Using the GPU / high-memory nodes<a class="headerlink" href="#using-the-gpu-high-memory-nodes" title="Permalink to this heading">#</a></h3>
<p>Running a job on the GPU / high-memory nodes is accomplished by
specifying that you want to use the <code class="docutils literal notranslate"><span class="pre">gpuqueue</span></code> by adding
<code class="docutils literal notranslate"><span class="pre">slurm_partition=&quot;gpuqueue&quot;</span></code> to the <code class="docutils literal notranslate"><span class="pre">resources</span></code> section of your
rule. Once you have done so, you can reserve GPUs using the
<code class="docutils literal notranslate"><span class="pre">slurm_extra</span></code> resource:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="n">gpu_example</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;my_input.dat&quot;</span>
    <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;my_output.dat&quot;</span>
    <span class="n">shell</span><span class="p">:</span> <span class="s2">&quot;my-command </span><span class="si">{input}</span><span class="s2"> &gt; </span><span class="si">{output}</span><span class="s2">&quot;</span>
    <span class="n">resources</span><span class="p">:</span>
        <span class="c1"># Run this rule on the GPU queue</span>
        <span class="n">slurm_partition</span><span class="o">=</span><span class="s2">&quot;gpuqueue&quot;</span><span class="p">,</span>
        <span class="c1"># Reserve 1 GPU for this job</span>
        <span class="n">slurm_extra</span><span class="o">=</span><span class="s2">&quot;--gres=gpu:1&quot;</span><span class="p">,</span>
</pre></div>
</div>
<p>If you need memory rather than GPUs, then omit the <code class="docutils literal notranslate"><span class="pre">slurm_extra</span></code>
resource and instead specify the amount of RAM needed in MB, using the
<code class="docutils literal notranslate"><span class="pre">mem_mb</span></code> resource as described above:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="n">high_mem_example</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;my_input.dat&quot;</span>
    <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;my_output.dat&quot;</span>
    <span class="n">shell</span><span class="p">:</span> <span class="s2">&quot;my-command </span><span class="si">{input}</span><span class="s2"> &gt; </span><span class="si">{output}</span><span class="s2">&quot;</span>
    <span class="n">resources</span><span class="p">:</span>
        <span class="c1"># Run this rule on the GPU queue</span>
        <span class="n">slurm_partition</span><span class="o">=</span><span class="s2">&quot;gpuqueue&quot;</span><span class="p">,</span>
        <span class="c1"># Reserve 3 TB of memory (specified in MB)</span>
        <span class="n">mem_mb</span><span class="o">=</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do <em>not</em> reserve GPUs if you do not need to use them; we only have a
few GPUs, so we will terminate jobs found to be unnecessarily
reserving GPU resources.</p>
</div>
</section>
</section>
<section id="using-environment-modules">
<h2>Using environment modules<a class="headerlink" href="#using-environment-modules" title="Permalink to this heading">#</a></h2>
<p>Snakemake can automatically load environment required by a rule. This
requires either that the <code class="docutils literal notranslate"><span class="pre">--use-envmodules</span></code> option is specified on the
command-line or that <code class="docutils literal notranslate"><span class="pre">use-envmodules</span></code> is set to <code class="docutils literal notranslate"><span class="pre">true</span></code> in your
profile (see below). When that is done, Snakemake will automatically
load the environment modules listed in the <code class="docutils literal notranslate"><span class="pre">envmodules</span></code> section of a
rule:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="n">my_rule</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;my_input.bam&quot;</span>
    <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;my_output.stats.txt&quot;</span>
    <span class="n">shell</span><span class="p">:</span> <span class="s2">&quot;samtools stats </span><span class="si">{input}</span><span class="s2"> &gt; </span><span class="si">{output}</span><span class="s2">&quot;</span>
    <span class="n">envmodules</span><span class="p">:</span>
        <span class="s2">&quot;libdeflate/1.18&quot;</span><span class="p">,</span>
        <span class="s2">&quot;samtools-libdeflate/1.18&quot;</span><span class="p">,</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Remember to specify version numbers for the module you are using;
this helps ensures that your analyses are reproducible and that they
won't suddenly break when new versions of modules are added.</p>
</div>
</section>
<section id="other-recommended-options">
<h2>Other recommended options<a class="headerlink" href="#other-recommended-options" title="Permalink to this heading">#</a></h2>
<p>This section describes a handful of settings that we recommend using:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--latency-wait</span> <span class="pre">60</span></code>: This option increases the length of time
snakemake will wait for missing output files to appear. This is
required when using <code class="docutils literal notranslate"><span class="pre">--slurm</span></code> since a job will be running on a
different node than snakemake itself and since it may take some
amount of times for files to propagate over the network filesystem.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--rerun-incomplete</span></code>: This option ensures that snakemake reruns
jobs that were not run to completion.</p></li>
</ul>
<p>The profile below enables you to automatically set these options.</p>
</section>
<section id="snakemake-profile">
<h2>Snakemake profile<a class="headerlink" href="#snakemake-profile" title="Permalink to this heading">#</a></h2>
<p>The recommended profile is also available at
<code class="docutils literal notranslate"><span class="pre">/projects/cbmr_shared/apps/config/snakemake/latest</span></code>. This is a
symlink pointing to the latest version of the profile</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Maximum number of jobs to queue at once</span>
<span class="nt">jobs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span>
<span class="c1"># Use slurm for queuing jobs</span>
<span class="nt">slurm</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="c1"># (Optional) Enable the use of environmental modules</span>
<span class="nt">use-envmodules</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="c1"># Wait up to 60 seconds for the network file system</span>
<span class="nt">latency-wait</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<span class="c1"># Re-run incomplete jobs</span>
<span class="nt">rerun-incomplete</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>

<span class="c1"># Standard slurm resources; these match the `sbatch` defaults:</span>
<span class="nt">default-resources</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># Use standard queue by default (silences warning)</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;slurm_partition=standardqueue&quot;</span>
<span class="w">  </span><span class="c1"># Same mem-per-CPU as Slurm defaults</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;mem_mb_per_cpu=15948&quot;</span>
<span class="w">  </span><span class="c1"># (Optional) Runtime limit in minutes to catch jobs that hang</span>
<span class="w">  </span><span class="c1">#- &quot;runtime=720&quot;</span>
</pre></div>
</div>
<p>This profile is also available at
<code class="docutils literal notranslate"><span class="pre">/projects/cbmr_shared/apps/config/snakemake/</span></code>.</p>
<p>To make use of the profile, run Snakemake with the <code class="docutils literal notranslate"><span class="pre">--profile</span></code>
argument and the location of the folder containing your profile:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>snakemake<span class="w"> </span>--profile<span class="w"> </span>/projects/cbmr_shared/apps/config/snakemake/latest
</pre></div>
</div>
<p>Options specified in this profile can be overridden on the command-line
simply by specifying the option again:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>snakemake<span class="w"> </span>--profile<span class="w"> </span>/projects/cbmr_shared/apps/config/snakemake/latest<span class="w"> </span>--jobs<span class="w"> </span><span class="m">16</span>
</pre></div>
</div>
</section>
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this heading">#</a></h2>
<section id="sacct-error-problem-talking-to-the-database-connection-refused">
<h3>sacct: error: Problem talking to the database: Connection refused<a class="headerlink" href="#sacct-error-problem-talking-to-the-database-connection-refused" title="Permalink to this heading">#</a></h3>
<p>If you are running Snakemake with the <code class="docutils literal notranslate"><span class="pre">--slurm</span></code> option on a compete
node, i.e. not the head node, then you will receive errors such as the
following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Job 0 has been submitted with SLURM jobid 512921 (log: .snakemake/slurm_logs/rule_foo/512921.log).</span>
<span class="go">The job status query failed with command: sacct -X --parsable2 --noheader --format=JobIdRaw,State --name 2d898259-73e4-435d-aa77-44dc44d84c1b</span>
<span class="go">Error message: sacct: error: slurm_persist_conn_open_without_init: failed to open persistent connection to host:localhost:6819: Connection refused</span>
<span class="go">sacct: error: Sending PersistInit msg: Connection refused</span>
<span class="go">sacct: error: Problem talking to the database: Connection refused</span>
</pre></div>
</div>
<p>To solve this, simply start your Snakemake pipeline on the head node
when using the <code class="docutils literal notranslate"><span class="pre">--slurm</span></code> option.</p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../communications/messages.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Welcome email</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="robust_scripts.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Writing robust bash scripts</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023-2024, CBMR Data Analytics; licensed under CC-BY 4.0
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Using Snakemake on Esrum</a><ul>
<li><a class="reference internal" href="#running-snakemake-with-slurm-support">Running Snakemake with Slurm support</a><ul>
<li><a class="reference internal" href="#requesting-cpus">Requesting CPUs</a></li>
<li><a class="reference internal" href="#requesting-memory">Requesting memory</a></li>
<li><a class="reference internal" href="#using-the-gpu-high-memory-nodes">Using the GPU / high-memory nodes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-environment-modules">Using environment modules</a></li>
<li><a class="reference internal" href="#other-recommended-options">Other recommended options</a></li>
<li><a class="reference internal" href="#snakemake-profile">Snakemake profile</a></li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li><a class="reference internal" href="#sacct-error-problem-talking-to-the-database-connection-refused">sacct: error: Problem talking to the database: Connection refused</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../_static/js/custom.js?v=3a8ddbd3"></script>
    <script src="../_static/js/libgif.js?v=7adcb026"></script>
    <script src="../_static/js/playback.js?v=d7002ce9"></script>
    </body>
</html>