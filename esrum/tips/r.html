<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="search" title="Search" href="../search.html" /><link rel="next" title="Welcome email" href="../communications/messages.html" /><link rel="prev" title="Using Snakemake on Esrum" href="snakemake.html" />

    <!-- Generated with Sphinx 7.4.7 and Furo 2024.04.27 -->
        <title>Using R on Esrum - Esrum Cluster documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=437aa6ec" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../_static/css/playback.css?v=2c0b8537" />
    <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=14071cef" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Esrum Cluster  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">Esrum Cluster  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Front page</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">Contact us</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview of cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guidelines.html">Guidelines and policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using the cluster</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../usage/access/access.html">Applying for access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/access/connecting.html">Connecting to the cluster</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../usage/filesystem.html">Data storage on Esrum</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Data storage on Esrum</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../usage/projects.html">Requesting projects and datasets</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../usage/slurm/index.html">Running jobs using Slurm</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Running jobs using Slurm</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../usage/slurm/basics.html">Basic Slurm jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/slurm/advanced.html">Advanced Slurm jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/slurm/monitoring.html">Monitoring slurm jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/slurm/gpu.html">GPU / high-memory jobs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../usage/modules.html">Software on Esrum</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../usage/transfers/index.html">Transferring data</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Transferring data</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../usage/transfers/internal.html">Internal data transfers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/transfers/external.html">External data transfers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/transfers/services.html">Cloud services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/transfers/misc.html">Miscellaneous</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../resources/cohorts.html">Human cohorts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources/common.html">Common datasets</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other services</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../services/rstudio.html">RStudio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/networkdrives.html">Network drives (H:, N:, S:)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/jupyter.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/containers.html">Containerized software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/shiny.html">Shiny servers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tips and tricks</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ports.html">Port forwarding</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">Creating environment modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="tmux.html">Persistent sessions with tmux</a></li>
<li class="toctree-l1"><a class="reference internal" href="batching_commands.html">Batching commands in bash</a></li>
<li class="toctree-l1"><a class="reference internal" href="robust_scripts.html">Writing robust bash scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="snakemake.html">Using Snakemake on Esrum</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Using R on Esrum</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Outreach</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../communications/messages.html">Welcome email</a></li>
<li class="toctree-l1"><a class="reference internal" href="../communications/presentations.html">Presentations</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/cbmr-data/cbmr-data.github.io/edit/main/esrum/source/tips/r.rst" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="using-r-on-esrum">
<span id="p-tips-r"></span><h1>Using R on Esrum<a class="headerlink" href="#using-r-on-esrum" title="Link to this heading">¶</a></h1>
<p>This section how to use R on Esrum and lays out various tips for making
your work easier. This section is primarily focused on running R
non-interactively via Slurm, in order to take full advantage of the
available compute resources.</p>
<p>For interactive work, we recommend using the <a class="reference internal" href="../services/rstudio.html#p-service-rstudio"><span class="std std-ref">RStudio</span></a>
servers or using an <a class="reference internal" href="../usage/slurm/basics.html#s-interactive-session"><span class="std std-ref">Interactive sessions</span></a>.</p>
<section id="selecting-an-r-version">
<h2>Selecting an R version<a class="headerlink" href="#selecting-an-r-version" title="Link to this heading">¶</a></h2>
<p>Several versions of R are available via the module system. To load
these, you need to load the version of R you want <em>and</em> a version of
<a class="reference external" href="https://gcc.gnu.org/">GCC</a>, which is required to install/load R libraries.</p>
<p>If you intend to also make use of the RStudio servers, then we recommend
that you <code class="docutils literal notranslate"><span class="pre">R/4.3.3</span></code> (or another version of <code class="docutils literal notranslate"><span class="pre">R/4.3.x</span></code>) with
<code class="docutils literal notranslate"><span class="pre">gcc/8.5.0</span></code>. This ensures that the R libraries you install are
compatible between the compute nodes and the RStudio servers.</p>
<p>By default, the 4.3.x versions of R loads <code class="docutils literal notranslate"><span class="pre">gcc/8.5.0</span></code>, so you can
simply use the <code class="docutils literal notranslate"><span class="pre">--auto</span></code> option when loading <code class="docutils literal notranslate"><span class="pre">R/4.3.x</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>module<span class="w"> </span>load<span class="w"> </span>--auto<span class="w"> </span>R/4.3.3
<span class="go">Loading R/4.3.3</span>
<span class="go">  Loading requirement: gcc/8.5.0</span>
</pre></div>
</div>
<p>R modules installed using versions of R other than <code class="docutils literal notranslate"><span class="pre">4.3.x</span></code> will not be
available on the RStudio server, and you will need to install them
again.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Using a GCC version greater than 8.x with <code class="docutils literal notranslate"><span class="pre">R/4.3.x</span></code> may cause
modules you install to fail to load on the RStudio server with the
errors similar to the following:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Error: package or namespace load failed for ‘wk’ in dyn.load(file, DLLpath = DLLpath, ...):
unable to load shared object &#39;/home/abc123/R/x86_64-pc-linux-gnu-library/4.3/wk/libs/wk.so&#39;:
/lib64/libstdc++.so.6: version `GLIBCXX_3.4.26&#39; not found (required by /home/abc123/R/x86_64-pc-linux-gnu-library/4.3/wk/libs/wk.so)
</pre></div>
</div>
<p>See the Troubleshooting section below for more information.</p>
</div>
</section>
<section id="submitting-r-scripts-using-slurm">
<h2>Submitting R scripts using Slurm<a class="headerlink" href="#submitting-r-scripts-using-slurm" title="Link to this heading">¶</a></h2>
<p>The recommended way to run R on Esrum is as non-interactive scripts
submitted to slurm. This not only ensures that your analyses do not
impact other users, but also makes your analyses reproducible.</p>
<p>To run an R script on the command-line, simply use the <code class="docutils literal notranslate"><span class="pre">Rscript</span></code>
command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>my_script.R
<span class="go">cat(&quot;Hello, world!\n&quot;)</span>
<span class="gp">$ </span>Rscript<span class="w"> </span>my_script.R
<span class="go">Hello, world!</span>
</pre></div>
</div>
<p>For simple scripts you can use the <code class="docutils literal notranslate"><span class="pre">commandArgs</span></code> function to pass
arguments to your scripts, allowing you to use them to process arbitrary
data-sets:</p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">args</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">commandArgs</span><span class="p">(</span><span class="n">trailingOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Hello, &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;!\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>Rscript<span class="w"> </span>my_script.R<span class="w"> </span>world
<span class="go">Hello, world!</span>
</pre></div>
</div>
<p>If your script requires a heterogeneous set of input files or options to
run, then it is recommended to use an argument parser such as the
<a class="reference external" href="https://cran.r-project.org/web/packages/argparser/index.html">argparser</a> R library. To use the <code class="docutils literal notranslate"><span class="pre">argparser</span></code> library you must first
install it using the <code class="docutils literal notranslate"><span class="pre">install.packages(&quot;argparser&quot;)</span></code> command.</p>
<p>The following shows a brief example of how you might use the
<code class="docutils literal notranslate"><span class="pre">argparser</span></code> library. It can also be downloaded <a class="reference download internal" download="" href="../_downloads/50776684ebe76d5c0bfb781ff5577690/argparser.R"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>.</p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="c1">#!/usr/bin/env Rscript</span>
<span class="nf">library</span><span class="p">(</span><span class="n">argparser</span><span class="p">)</span>

<span class="n">parser</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">arg_parser</span><span class="p">(</span><span class="s">&quot;This is my script!&quot;</span><span class="p">)</span>

<span class="n">parser</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">add_argument</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;input_file&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">help</span><span class="o">=</span><span class="s">&quot;My data&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">add_argument</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;--p-value&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">default</span><span class="o">=</span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Maximum P-value&quot;</span><span class="p">)</span>

<span class="n">args</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">parse_args</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;I would process the file&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">$</span><span class="n">input_file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;with a max P-value of&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">$</span><span class="n">p_value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This allows you to document your command-line options, specify default
values, and much more:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>Rscript<span class="w"> </span>my_script.R
<span class="go">usage: my_script.R [--] [--help] [--opts OPTS] [--p-value P-VALUE]</span>
<span class="go">    input_file</span>

<span class="go">This is my script!</span>

<span class="go">positional arguments:</span>
<span class="go">input_file     My data</span>

<span class="go">flags:</span>
<span class="go">-h, --help     show this help message and exit</span>

<span class="go">optional arguments:</span>
<span class="go">-x, --opts     RDS file containing argument values</span>
<span class="go">-p, --p-value  Maximum P-value [default: 0.05]</span>

<span class="go">Error in parse_args(parser) :</span>
<span class="go">Missing required arguments: expecting 1 values but got 0 values: ().</span>
<span class="go">Execution halted</span>
<span class="gp">$ </span>Rscript<span class="w"> </span>my_script.R<span class="w"> </span>my_data.tsv
<span class="go">I would process the file my_data.tsv with a max P-value of 0.05</span>
</pre></div>
</div>
<p>Finally, you write can write a small bash script to automatically load
the required version of R and to call your script when you submit it to
Slurm (using your preferred version of R):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="ch">#!/bin/bash</span>
<span class="linenos">2</span>
<span class="linenos">3</span>module<span class="w"> </span>load<span class="w"> </span>gcc/8.5.0<span class="w"> </span>R/4.1.2
<span class="linenos">4</span>Rscript<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="p">@</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">&quot;${&#64;}&quot;</span></code> safely passes all your command-line arguments to
<code class="docutils literal notranslate"><span class="pre">Rscript</span></code>, even if they contain spaces. This wrapper script can then
be used to submit/call any of your R-scripts:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sbatch<span class="w"> </span>run_rscript.sh<span class="w"> </span>my_script.R<span class="w"> </span>my_data.tsv<span class="w"> </span>--p-value<span class="w"> </span><span class="m">0</span>.01
<span class="go">Submitted batch job 18090212</span>
<span class="gp">$ </span>cat<span class="w"> </span>slurm-18090212.out
<span class="go">I would process the file my_data.tsv with a max P-value of 0.01</span>
</pre></div>
</div>
</section>
<section id="installing-r-modules">
<h2>Installing R modules<a class="headerlink" href="#installing-r-modules" title="Link to this heading">¶</a></h2>
<section id="basics-of-installing-packages">
<h3>Basics of installing packages<a class="headerlink" href="#basics-of-installing-packages" title="Link to this heading">¶</a></h3>
<p>Modules may be installed in your home folder using the
<code class="docutils literal notranslate"><span class="pre">install.packages</span></code> command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>module<span class="w"> </span>load<span class="w"> </span>gcc/8.5.0<span class="w"> </span>R/4.3.1
<span class="gp">$ </span>R
<span class="go">&gt; install.packages(&quot;ggplot2&quot;)</span>
<span class="go">Warning in install.packages(&quot;ggplot2&quot;) :</span>
<span class="go">  &#39;lib = &quot;/opt/software/R/4.3.1/lib64/R/library&quot;&#39; is not writable</span>
<span class="go">Would you like to use a personal library instead? (yes/No/cancel) yes</span>
<span class="go">Would you like to create a personal library</span>
<span class="go">‘/home/abc123/R/x86_64-pc-linux-gnu-library/4.3’</span>
<span class="go">to install packages into? (yes/No/cancel) yes</span>
</pre></div>
</div>
<p>When asked to pick a mirror, either pick <code class="docutils literal notranslate"><span class="pre">0-Cloud</span></code> by entering <code class="docutils literal notranslate"><span class="pre">1</span></code>
and pressing enter, or enter the number corresponding to a location near
you and press enter:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>--- Please select a CRAN mirror for use in this session ---
Secure CRAN mirrors

1: 0-Cloud [https]
[...]

Selection: 1
</pre></div>
</div>
</section>
<section id="selecting-a-default-mirror">
<h3>Selecting a default mirror<a class="headerlink" href="#selecting-a-default-mirror" title="Link to this heading">¶</a></h3>
<p>It is possible to select a default package mirror and thereby simplify
the installation process. To set the default to <code class="docutils literal notranslate"><span class="pre">0-Cloud</span></code>, add the
following command to your <code class="docutils literal notranslate"><span class="pre">~/.Rprofile</span></code> file:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">options</span><span class="p">(</span><span class="n">repos</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">CRAN</span><span class="o">=</span><span class="s">&quot;https://cloud.r-project.org/&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>This can be done by running the following command in your (bash) shell:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;\noptions(repos=c(CRAN=&quot;https://cloud.r-project.org/&quot;))&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>~/.Rprofile
</pre></div>
</div>
<p>Note that this does not affect already running R shells.</p>
</section>
<section id="speeding-up-package-installs">
<h3>Speeding up package installs<a class="headerlink" href="#speeding-up-package-installs" title="Link to this heading">¶</a></h3>
<p>By default, R only uses a single thread when compiling packages and for
large packages, this can result in very long installation times. To
improve this situation, we can tell the build system to use more than
one thread by setting the <code class="docutils literal notranslate"><span class="pre">MAKEFLAGS</span></code> environment variable.</p>
<p>For example, to install the <code class="docutils literal notranslate"><span class="pre">ape</span></code> package:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>srun<span class="w"> </span>--pty<span class="w"> </span>-c<span class="w"> </span><span class="m">8</span><span class="w"> </span>--<span class="w"> </span>bash
$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">MAKEFLAGS</span><span class="o">=</span><span class="s2">&quot;-j</span><span class="si">${</span><span class="nv">SLURM_CPUS_PER_TASK</span><span class="si">}</span><span class="s2">&quot;</span>
$<span class="w"> </span>R
&gt;<span class="w"> </span>install.packages<span class="o">(</span><span class="s2">&quot;ape&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>This starts an interactive session on Slurm with 8 CPUs reserved,
configure the <code class="docutils literal notranslate"><span class="pre">make</span></code> command (used to build R packages) to use up to 8
CPUs at once, and then install the package(s) we are interested in.</p>
<p>To automatically set use the number of CPUs you've reserved, add the
following command to your <code class="docutils literal notranslate"><span class="pre">~/.Rprofile</span></code> file:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Sys.setenv(&quot;MAKEFLAGS&quot; = sprintf(&quot;-j%i&quot;, max(2, as.numeric(Sys.getenv(&quot;SLURM_CPUS_PER_TASK&quot;, &quot;2&quot;)))))
</pre></div>
</div>
<p>This can be done by running the following command in bash:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span><span class="w"> </span><span class="s">&#39;Sys.setenv(&quot;MAKEFLAGS&quot; = sprintf(&quot;-j%i&quot;, max(2, as.numeric(Sys.getenv(&quot;SLURM_CPUS_PER_TASK&quot;, &quot;2&quot;)))))&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tee</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="o">~/</span><span class="n">.Rprofile</span>
</pre></div>
</div>
<p>This command sets the number of CPUs <code class="docutils literal notranslate"><span class="pre">make</span></code> can use in R to the number
you've reserved via Slurm, but no less than 2. This is an acceptable
number on the head node, and generally gives better performance even if
you've only reserved a single CPU.</p>
<p>You can further speed up installations involving multiple packages by
calling <code class="docutils literal notranslate"><span class="pre">options(Ncpus=2)</span></code> <em>before</em> calling <code class="docutils literal notranslate"><span class="pre">ìnstall.packages</span></code>. This
enables R to build and install two packages simultaneously, in addition
to using more CPUs to build each package.</p>
<p>To enable this option by default, append it to your <code class="docutils literal notranslate"><span class="pre">~/.Rprofile</span></code>
file. This can be done by running the following command in bash:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;options(Ncpus=2)&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>~/.Rprofile
</pre></div>
</div>
<p>Note, however, that this changes how R prints the output from the
packages it is installing: Instead of showing live output, R prints the
complete output <em>after</em> a package has been installed, which may give the
impression that the installation processing has frozen.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Installing R packages on the head node while using more resources
than the equivalent of <code class="docutils literal notranslate"><span class="pre">MAKEFLAGS=-j2</span></code> and <code class="docutils literal notranslate"><span class="pre">options(Ncpus=2)</span></code>,
may result in your R session getting killed without warning. If you
use the suggested commands above, then this won't happen. Please use
<a class="reference internal" href="../usage/slurm/basics.html#s-interactive-session"><span class="std std-ref">interactive sessions</span></a> otherwise.</p>
</div>
</section>
</section>
<section id="troubleshooting">
<span id="s-service-rstudio"></span><h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Link to this heading">¶</a></h2>
<section id="libtk8-6-so-cannot-open-shared-object-file">
<h3>libtk8.6.so: cannot open shared object file<a class="headerlink" href="#libtk8-6-so-cannot-open-shared-object-file" title="Link to this heading">¶</a></h3>
<p>Users connecting to Esrum with X11 forwarding enabled, for example using
MobaXterm with default settings, may observe the following error when
running the <code class="docutils literal notranslate"><span class="pre">install.packages</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>--- Please select a CRAN mirror for use in this session ---
Error: .onLoad failed in loadNamespace() for &#39;tcltk&#39;, details:
  call: dyn.load(file, DLLpath = DLLpath, ...)
  error: unable to load shared object &#39;/opt/software/R/4.3.1/lib64/R/library/tcltk/libs/tcltk.so&#39;:
  libtk8.6.so: cannot open shared object file: No such file or directory
</pre></div>
</div>
<p>If so, then you must disable graphical menus before running
<code class="docutils literal notranslate"><span class="pre">install.packages</span></code> by first entering the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&gt; options(menu.graphics=FALSE)</span>
</pre></div>
</div>
<p>Then simply run <code class="docutils literal notranslate"><span class="pre">install.packages</span></code> again.</p>
<p>You can also set the R option permanently by running the following in
your (bash) terminal:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;options(menu.graphics=FALSE)&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>~/.Rprofile
</pre></div>
</div>
</section>
<section id="libicui18n-so-73-cannot-open-shared-object-file-no-such-file-or-directory">
<h3>libicui18n.so.73: cannot open shared object file: No such file or directory<a class="headerlink" href="#libicui18n-so-73-cannot-open-shared-object-file-no-such-file-or-directory" title="Link to this heading">¶</a></h3>
<p>If you have conda installed, and if you are using R from an environment
module, then libraries may fail to install with the error message that
<code class="docutils literal notranslate"><span class="pre">libicui18n.so.73:</span> <span class="pre">cannot</span> <span class="pre">open</span> <span class="pre">shared</span> <span class="pre">object</span> <span class="pre">file:</span> <span class="pre">No</span> <span class="pre">such</span> <span class="pre">file</span> <span class="pre">or</span>
<span class="pre">directory</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Error: package or namespace load failed for &#39;xml2&#39; in dyn.load(file, DLLpath = DLLpath, ...): unable to load shared object &#39;/home/abc1232/R/x86_64-pc-linux-gnu-library/4.5/00LOCK-xml2/00new/xml2/libs/xml2.so&#39;: libicui18n.so.73: cannot open shared object file: No such file or directory
</pre></div>
</div>
<p>To fix this, deactivate your conda environments (including <code class="docutils literal notranslate"><span class="pre">base</span></code>)
before installing the library. For example, to install the <code class="docutils literal notranslate"><span class="pre">xml2</span></code>
library:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(my-env)</span> <span class="gp">$ </span>conda<span class="w"> </span>deactivate
<span class="gp gp-VirtualEnv">(base)</span> <span class="gp">$ </span>conda<span class="w"> </span>deactivate
<span class="gp">$ </span>R
<span class="go">&gt; install.packages(&quot;xml2&quot;)</span>
</pre></div>
</div>
</section>
<section id="libstdc-so-6-version-glibcxx-3-4-26-not-found">
<h3>libstdc++.so.6: version <code class="docutils literal notranslate"><span class="pre">'GLIBCXX_3.4.26'</span></code> not found<a class="headerlink" href="#libstdc-so-6-version-glibcxx-3-4-26-not-found" title="Link to this heading">¶</a></h3>
<p>If you build an R library on the head/compute nodes using a version of
the GCC module other than <code class="docutils literal notranslate"><span class="pre">gcc/8.5.0</span></code>, then this library may fail to
load on the RStudio node or when <code class="docutils literal notranslate"><span class="pre">gcc/8.5.0</span></code> is loaded on the
head/compute nodes:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>R
<span class="go">&gt; library(wk)</span>
<span class="go">Error: package or namespace load failed for ‘wk’ in dyn.load(file, DLLpath = DLLpath, ...):</span>
<span class="go">unable to load shared object &#39;/home/abc123/R/x86_64-pc-linux-gnu-library/4.3/wk/libs/wk.so&#39;:</span>
<span class="go">/lib64/libstdc++.so.6: version `GLIBCXX_3.4.26&#39; not found (required by /home/abc123/R/x86_64-pc-linux-gnu-library/4.3/wk/libs/wk.so)</span>
</pre></div>
</div>
<p>To fix his, you will need to reinstall the affected R libraries using
one of two methods:</p>
<ol class="arabic">
<li><p>Connect to the RStudio server as described in the
<a class="reference internal" href="#s-service-rstudio"><span class="std std-ref">Troubleshooting</span></a> section, and simply install the affected
packages using the <code class="docutils literal notranslate"><span class="pre">install.packages</span></code> function:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&gt; install.packages(&quot;wk&quot;)</span>
</pre></div>
</div>
<p>You may need to repeat this step multiple times, for every package
that fails to load.</p>
</li>
<li><p>Connect to the head node or a compute node, and take care to load the
correct version of GCC before loading R:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>module<span class="w"> </span>load<span class="w"> </span>gcc/8.5.0<span class="w"> </span>R/4.3.2
<span class="gp">$ </span>R
<span class="go">&gt; install.packages(&quot;wk&quot;)</span>
</pre></div>
</div>
</li>
</ol>
<p>The name of the affected module can be determined by looking at the
error message above. In particular, the path
<code class="docutils literal notranslate"><span class="pre">/home/abc123/R/x86_64-pc-linux-gnu-library/4.3/wk/libs/wk.so</span></code>
contains a pair of folders named <code class="docutils literal notranslate"><span class="pre">R/x86_64-pc-linux-gnu-library</span></code>,
which specifies the kind of system we are running on. Immediately after
that we find the package name, namely <code class="docutils literal notranslate"><span class="pre">wk</span></code> in this case.</p>
<p>You can identify all affected packages in your &quot;global&quot; R library by
running the following commands:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>module<span class="w"> </span>load<span class="w"> </span>gcc/8.5.0<span class="w"> </span>R/4.3.2
</pre></div>
</div>
<ol class="arabic">
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span></code> to your R library</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>~/R/x86_64-pc-linux-gnu-library/4.3/
</pre></div>
</div>
</li>
<li><p>Test every installed library</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="k">for</span><span class="w"> </span>lib<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>ls<span class="k">)</span><span class="p">;</span><span class="k">do</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Testing </span><span class="si">${</span><span class="nv">lib</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span>Rscript<span class="w"> </span>&lt;<span class="o">(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;library(</span><span class="si">${</span><span class="nv">lib</span><span class="si">}</span><span class="s2">)&quot;</span><span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="k">done</span>
</pre></div>
</div>
</li>
</ol>
<p>Output will look like the following:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Testing httpuv
Testing igraph
Error: package or namespace load failed for ‘igraph’ in dyn.load(file, DLLpath = DLLpath, ...):
unable to load shared object &#39;/home/abc123/R/x86_64-pc-linux-gnu-library/4.3/igraph/libs/igraph.so&#39;:
/opt/software/gcc/8.5.0/lib64/libstdc++.so.6: version `GLIBCXX_3.4.29&#39; not found (required by /home/abc123/R/x86_64-pc-linux-gnu-library/4.3/igraph/libs/igraph.so)
Execution halted
Testing isoband
Error: package or namespace load failed for ‘isoband’ in dyn.load(file, DLLpath = DLLpath, ...):
unable to load shared object &#39;/home/abc123/R/x86_64-pc-linux-gnu-library/4.3/isoband/libs/isoband.so&#39;:
/opt/software/gcc/8.5.0/lib64/libstdc++.so.6: version`GLIBCXX_3.4.29&#39; not found (required by /home/abc123/R/x86_64-pc-linux-gnu-library/4.3/isoband/libs/isoband.so)
Execution halted
Testing labeling
Testing later
</pre></div>
</div>
<p>Locate the error messages like the one shown above in the output and
reinstall the affected libraries using the <code class="docutils literal notranslate"><span class="pre">install.packages</span></code> command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>R
<span class="go">&gt; install.packages(c(&quot;igraph&quot;, &quot;isoband&quot;))</span>
</pre></div>
</div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../communications/messages.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Welcome email</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="snakemake.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Using Snakemake on Esrum</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023-2024, CBMR Data Analytics; licensed under CC-BY 4.0
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Using R on Esrum</a><ul>
<li><a class="reference internal" href="#selecting-an-r-version">Selecting an R version</a></li>
<li><a class="reference internal" href="#submitting-r-scripts-using-slurm">Submitting R scripts using Slurm</a></li>
<li><a class="reference internal" href="#installing-r-modules">Installing R modules</a><ul>
<li><a class="reference internal" href="#basics-of-installing-packages">Basics of installing packages</a></li>
<li><a class="reference internal" href="#selecting-a-default-mirror">Selecting a default mirror</a></li>
<li><a class="reference internal" href="#speeding-up-package-installs">Speeding up package installs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li><a class="reference internal" href="#libtk8-6-so-cannot-open-shared-object-file">libtk8.6.so: cannot open shared object file</a></li>
<li><a class="reference internal" href="#libicui18n-so-73-cannot-open-shared-object-file-no-such-file-or-directory">libicui18n.so.73: cannot open shared object file: No such file or directory</a></li>
<li><a class="reference internal" href="#libstdc-so-6-version-glibcxx-3-4-26-not-found">libstdc++.so.6: version <code class="docutils literal notranslate"><span class="pre">'GLIBCXX_3.4.26'</span></code> not found</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=4e2eecee"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=a7c4b63f"></script>
    <script src="../_static/js/custom.js?v=d3d7fd27"></script>
    <script src="../_static/js/libgif.js?v=7adcb026"></script>
    <script src="../_static/js/playback.js?v=d7002ce9"></script>
    </body>
</html>