<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="search" title="Search" href="../search.html" /><link rel="next" title="Using Snakemake on Esrum" href="snakemake.html" /><link rel="prev" title="Batching commands in bash" href="batching_commands.html" />

    <!-- Generated with Sphinx 7.1.2 and Furo 2024.01.29 -->
        <title>Writing robust bash scripts - Esrum Cluster documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../_static/css/playback.css?v=2c0b8537" />
    <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e2322aab" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Esrum Cluster  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">Esrum Cluster  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">Contact</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview of cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guidelines.html">Guidelines and policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using the cluster</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../usage/access/access.html">Applying for access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/access/connecting.html">Connecting to the cluster</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../usage/filesystem.html">Data storage on Esrum</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Data storage on Esrum</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../usage/projects.html">Creating projects and datasets</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../usage/slurm/index.html">Running jobs using Slurm</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Running jobs using Slurm</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../usage/slurm/basics.html">Basic Slurm jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/slurm/advanced.html">Advanced Slurm jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/slurm/gpu.html">Using the GPU / high-memory nodes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../usage/modules.html">Software on Esrum</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/transfers.html">Transferring data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../resources/cohorts.html">Human Cohorts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other services</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../services/r.html">R and RStudio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/jupyter.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/containers.html">Containerized software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/shiny.html">Shiny servers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tips and tricks</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="modules.html">Creating environment modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="tmux.html">Persistent sessions with tmux</a></li>
<li class="toctree-l1"><a class="reference internal" href="batching_commands.html">Batching commands in bash</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Writing robust bash scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="snakemake.html">Using Snakemake on Esrum</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Outreach</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../communications/messages.html">Welcome email</a></li>
<li class="toctree-l1"><a class="reference internal" href="../communications/presentations.html">Presentations</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/cbmr-data/cbmr-data.github.io/edit/main/esrum/source/tips/robust_scripts.rst" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="writing-robust-bash-scripts">
<span id="p-tips-robustscripts"></span><h1>Writing robust bash scripts<a class="headerlink" href="#writing-robust-bash-scripts" title="Permalink to this heading">#</a></h1>
<p>Bash scripts are useful for automating tasks and for running batch jobs.
However, the default behavior of bash is to keep running when errors
happen, and that can result in undesirable behavior such as running
programs with the wrong settings, analyzing bad data, and worse. This
page is written on the premise that it is better to fail loudly than to
generate bad results or do bad things quietly.</p>
<p>However, because of the many, many <a class="reference external" href="https://mywiki.wooledge.org/BashPitfalls">bash pitfalls</a>, using a more robust
programming language when performing more complex tasks is recommended.</p>
<section id="improving-default-bash-behavior">
<h2>Improving default bash behavior<a class="headerlink" href="#improving-default-bash-behavior" title="Permalink to this heading">#</a></h2>
<p>This section describes several options that can make bash scripts behave
in a more reasonable manner.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>While it is possible to set these options in your shell, this is
<em>not</em> recommended since it will break scripts not designed with these
options in mind and can result in your terminal closing every time
you make a typo. For the same reason you <em>must not</em> set these options
in scripts that you import into your shell using the <code class="docutils literal notranslate"><span class="pre">source</span></code> or
<code class="docutils literal notranslate"><span class="pre">.</span></code> command.</p>
</div>
<section id="prevent-use-of-undefined-variables">
<h3>Prevent use of undefined variables<a class="headerlink" href="#prevent-use-of-undefined-variables" title="Permalink to this heading">#</a></h3>
<p>Variables are used for a variety of purposes in bash, including to
access slurm options in batch scripts. However, unlike in most
programming languages, it is not an error to access a variable that does
not exist:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>myscript.sh
<span class="c1">#!/bin/bash</span>
<span class="nv">MY_VARIABLE</span><span class="o">=</span><span class="s2">&quot;record&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Tourist: I will not buy this </span><span class="si">${</span><span class="nv">MY_VARIABL</span><span class="si">}</span><span class="s2">, it is scratched.&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Clerk: Sorry?&quot;</span>
$<span class="w"> </span>bash<span class="w"> </span>myscript.sh
Tourist:<span class="w"> </span>I<span class="w"> </span>will<span class="w"> </span>not<span class="w"> </span>buy<span class="w"> </span>this<span class="w"> </span>,<span class="w"> </span>it<span class="w"> </span>is<span class="w"> </span>scratched.
Clerk:<span class="w"> </span>Sorry?
</pre></div>
</div>
<p>Note how the script keeps executing even though we made a mistake. A
common mistake is therefore to misspell variables in scripts and have
bash silent do the wrong thing.</p>
<p>While there are cases where it is useful to allow missing variables,
most of the time this is a mistake. To prevent this, you can set the
<code class="docutils literal notranslate"><span class="pre">nounset</span></code> option, which causes bash to terminate on unset variables:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>myscript.sh
<span class="c1">#!/bin/bash</span>
<span class="nb">set</span><span class="w"> </span>-o<span class="w"> </span>nounset<span class="w">  </span><span class="c1"># Exit on unset variables</span>
<span class="nv">MY_VARIABLE</span><span class="o">=</span><span class="s2">&quot;record&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Tourist: I will not buy this </span><span class="si">${</span><span class="nv">MY_VARIABL</span><span class="si">}</span><span class="s2">, it is scratched.&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Clerk: Sorry?&quot;</span>
$<span class="w"> </span>bash<span class="w"> </span>myscript.sh
test.sh:<span class="w"> </span>line<span class="w"> </span><span class="m">4</span>:<span class="w"> </span>MY_VARIABL:<span class="w"> </span>unbound<span class="w"> </span>variable
</pre></div>
</div>
<p>This not only tells us that there is a problem with our script (and
where!), but it also stops bash from doing any more damage.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Should you <em>want</em> to allow a variable to be unset while using
<code class="docutils literal notranslate"><span class="pre">nounset</span></code>, you can use the <code class="docutils literal notranslate"><span class="pre">${name:-default}</span></code> pattern, where
<code class="docutils literal notranslate"><span class="pre">name</span></code> is the name of a variable and <code class="docutils literal notranslate"><span class="pre">default</span></code> is the text you
want to use if <code class="docutils literal notranslate"><span class="pre">name</span></code> is not set. To match the default behavior of
bash simply use <code class="docutils literal notranslate"><span class="pre">${name:-}</span></code>.</p>
</div>
</section>
<section id="stop-running-on-program-failures">
<h3>Stop running on program failures<a class="headerlink" href="#stop-running-on-program-failures" title="Permalink to this heading">#</a></h3>
<p>By default, bash (and hence Slurm) will continue to execute a script
even if a command fails. If this is not detected, then it can lead to
partially or wholly corrupt data:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># 1. Create some data</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;I wish to complain about this dog what I purchased not half an hour ago from this very boutique.&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>sketch.txt
<span class="c1"># 2. Process the data (badly)</span>
sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="s1">&#39;s# dog # parrot &#39;</span><span class="w"> </span>sketch.txt
<span class="c1"># 3. Etc.</span>
gzip<span class="w"> </span>sketch.txt
</pre></div>
</div>
<p>This produces the following output:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ls
my-sketch.sh
$<span class="w"> </span>bash<span class="w"> </span>my-sketch.sh
sed:<span class="w"> </span>-e<span class="w"> </span>expression<span class="w"> </span><span class="c1">#1, char 16: unterminated `s&#39; command</span>
$<span class="w"> </span>ls
my-sketch.sh<span class="w"> </span>sketch.txt.gz
$<span class="w"> </span>zcat<span class="w"> </span>sketch.txt.gz
I<span class="w"> </span>wish<span class="w"> </span>to<span class="w"> </span>complain<span class="w"> </span>about<span class="w"> </span>this<span class="w"> </span>dog<span class="w"> </span>what<span class="w"> </span>I<span class="w"> </span>purchased<span class="w"> </span>not<span class="w"> </span>half<span class="w"> </span>an<span class="w"> </span>hour<span class="w"> </span>ago<span class="w"> </span>from<span class="w"> </span>this<span class="w"> </span>very<span class="w"> </span>boutique.
</pre></div>
</div>
<p>In more complicated scripts and/or if slurm logs are not carefully
vetted, this can lead to completely unexpected results.</p>
<p>There are several ways to handle these kinds of errors. We call <code class="docutils literal notranslate"><span class="pre">exit</span></code>
with the argument (exit code) 1 to indicate to Slurm that the command
failed.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Exit if command fails, but nothing else</span>
sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="s1">&#39;s# dog # parrot &#39;</span><span class="w"> </span>sketch.txt<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="c1"># 2. Manually handle the failure</span>
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="s1">&#39;s# dog # parrot &#39;</span><span class="w"> </span>sketch.txt<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;We&#39;re closin&#39; for lunch.&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>
<span class="c1"># 3. Ignore failures, if the command is expected to fail sometimes.</span>
<span class="c1">#    This should be used with care!</span>
sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="s1">&#39;s# dog # parrot &#39;</span><span class="w"> </span>sketch.txt<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
</pre></div>
</div>
<p>This, however, does not work well if you wish to pipe commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="s1">&#39;s# dog # parrot &#39;</span><span class="w"> </span>sketch.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>gzip<span class="w"> </span>&gt;<span class="w"> </span>sketch.txt.gz<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;We&#39;re closin&#39; for lunch.&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>
</pre></div>
</div>
<p>Running this code does not print <code class="docutils literal notranslate"><span class="pre">We're</span> <span class="pre">closin'</span> <span class="pre">for</span> <span class="pre">lunch.</span></code>, because
the <code class="docutils literal notranslate"><span class="pre">gzip</span></code> command succeeds even if <code class="docutils literal notranslate"><span class="pre">sed</span></code> fails.</p>
<p>To mitigate these problems, we can make use of the following options:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="hll"><span class="c1"># Abort on unhandled failure in pipes</span>
</span><span class="hll"><span class="nb">set</span><span class="w"> </span>-o<span class="w"> </span>pipefail
</span><span class="hll"><span class="c1"># Ensure that custom functions inherit these options</span>
</span><span class="hll"><span class="nb">set</span><span class="w"> </span>-o<span class="w"> </span>errtrace
</span><span class="hll"><span class="c1"># Print debug message and terminate script on failures</span>
</span><span class="hll"><span class="nb">trap</span><span class="w"> </span><span class="s1">&#39;s=$?; echo &gt;&amp;2 &quot;$0: Error on line &quot;$LINENO&quot;: $BASH_COMMAND&quot;; exit $s&#39;</span><span class="w"> </span>ERR
</span>
<span class="c1"># 1. Create some data</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;I wish to complain about this dog what I purchased not half an hour ago from this very boutique.&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>sketch.txt
<span class="c1"># 2. Process the data (badly)</span>
sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="s1">&#39;s# dog # parrot &#39;</span><span class="w"> </span>sketch.txt
<span class="c1"># 3. Etc.</span>
gzip<span class="w"> </span>sketch.txt
</pre></div>
</div>
<p>Running this script produces the following, helpful output:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ls
my-sketch.sh
$<span class="w"> </span>bash<span class="w"> </span>my-sketch.sh
sed:<span class="w"> </span>-e<span class="w"> </span>expression<span class="w"> </span><span class="c1">#1, char 16: unterminated `s&#39; command</span>
sketch.sh:<span class="w"> </span>Error<span class="w"> </span>on<span class="w"> </span>line<span class="w"> </span><span class="m">13</span>:<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="s1">&#39;s# dog # parrot &#39;</span><span class="w"> </span>sketch.txt
$<span class="w"> </span>ls
my-sketch.sh<span class="w"> </span>sketch.txt
</pre></div>
</div>
</section>
<section id="prevent-bash-from-updating-running-scripts">
<h3>Prevent bash from updating running scripts<a class="headerlink" href="#prevent-bash-from-updating-running-scripts" title="Permalink to this heading">#</a></h3>
</section>
<section id="putting-it-all-together">
<h3>Putting it all together<a class="headerlink" href="#putting-it-all-together" title="Permalink to this heading">#</a></h3>
<p>The following bash script template combines the suggestions above and
thereby helps avoid <em>some</em> of the pitfalls of using bash</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># FIXME: SBATCH commands go here!</span>
<span class="o">{</span>
<span class="nb">set</span><span class="w"> </span>-o<span class="w"> </span>nounset<span class="w">  </span><span class="c1"># Exit on unset variables</span>
<span class="nb">set</span><span class="w"> </span>-o<span class="w"> </span>pipefail<span class="w"> </span><span class="c1"># Exit on unhandled failure in pipes</span>
<span class="nb">set</span><span class="w"> </span>-o<span class="w"> </span>errtrace<span class="w"> </span><span class="c1"># Have functions inherit ERR traps</span>
<span class="c1"># Print debug message and terminate script on non-zero return codes</span>
<span class="nb">trap</span><span class="w"> </span><span class="s1">&#39;s=$?; echo &gt;&amp;2 &quot;$0: Error on line &quot;$LINENO&quot;: $BASH_COMMAND&quot;; exit $s&#39;</span><span class="w"> </span>ERR

<span class="c1"># FIXME: Your commands go here!</span>

<span class="c1"># Prevent the script from continuing if the file has changed</span>
<span class="nb">exit</span><span class="w"> </span><span class="nv">$?</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Note however that is not guaranteed to catch all errors (see the <a class="reference external" href="https://mywiki.wooledge.org/BashPitfalls">bash
pitfalls</a> page for more information) and it is therefore recommended to
use a more robust programming language or proper pipeline for more
complicated tasks.</p>
</section>
</section>
<section id="checking-your-scripts-for-common-mistakes">
<h2>Checking your scripts for common mistakes<a class="headerlink" href="#checking-your-scripts-for-common-mistakes" title="Permalink to this heading">#</a></h2>
<p>In addition to implementing the suggestions listed on this page, it is
recommended that you use the <a class="reference external" href="https://github.com/koalaman/shellcheck">ShellCheck</a> to check your bash scripts for
common mistakes.</p>
<p>For example, if we run shell check on the very first script shown on
this page:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>module<span class="w"> </span>load<span class="w"> </span>shellcheck
$<span class="w"> </span>shellcheck<span class="w"> </span>myscript.sh

In<span class="w"> </span>myscript.sh<span class="w"> </span>line<span class="w"> </span><span class="m">2</span>:
<span class="nv">MY_VARIABLE</span><span class="o">=</span><span class="s2">&quot;record&quot;</span>
^---------^<span class="w"> </span>SC2034<span class="w"> </span><span class="o">(</span>warning<span class="o">)</span>:<span class="w"> </span>MY_VARIABLE<span class="w"> </span>appears<span class="w"> </span>unused.<span class="w"> </span>Verify<span class="w"> </span>use<span class="w"> </span><span class="o">(</span>or<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="k">if</span><span class="w"> </span>used<span class="w"> </span>externally<span class="o">)</span>.

In<span class="w"> </span>myscript.sh<span class="w"> </span>line<span class="w"> </span><span class="m">3</span>:
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;I will not buy this </span><span class="si">${</span><span class="nv">MY_VARIABL</span><span class="si">}</span><span class="s2">, it is scratched.&quot;</span>
<span class="w">                        </span>^-----------^<span class="w"> </span>SC2153<span class="w"> </span><span class="o">(</span>info<span class="o">)</span>:<span class="w"> </span>Possible<span class="w"> </span>misspelling:<span class="w"> </span>MY_VARIABL<span class="w"> </span>may<span class="w"> </span>not<span class="w"> </span>be<span class="w"> </span>assigned.<span class="w"> </span>Did<span class="w"> </span>you<span class="w"> </span>mean<span class="w"> </span>MY_VARIABLE?
</pre></div>
</div>
</section>
<section id="running-commands-in-snakemake">
<h2>Running commands in Snakemake<a class="headerlink" href="#running-commands-in-snakemake" title="Permalink to this heading">#</a></h2>
<p>If you are using Snakemake to run your bash commands, then you are
already running commands in a <a class="reference external" href="https://snakemake.readthedocs.io/en/stable/project_info/faq.html#my-shell-command-fails-with-exit-code-0-from-within-a-pipe-what-s-wrong">&quot;strict&quot; bash mode</a>, namely with <code class="docutils literal notranslate"><span class="pre">set</span>
<span class="pre">-euo</span> <span class="pre">pipefail</span></code>. This sets the <code class="docutils literal notranslate"><span class="pre">nounset</span></code> and <code class="docutils literal notranslate"><span class="pre">pipefail</span></code> options
mentioned above, as well as the <code class="docutils literal notranslate"><span class="pre">errexit</span></code> option that is equivalent to
the <code class="docutils literal notranslate"><span class="pre">trap</span></code> command above but which prints less information about the
failure:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>snakemake
sed:<span class="w"> </span>-e<span class="w"> </span>expression<span class="w"> </span><span class="c1">#1, char 16: unterminated `s&#39; command</span>
<span class="o">[</span>Thu<span class="w"> </span>Aug<span class="w"> </span><span class="m">29</span><span class="w"> </span><span class="m">11</span>:26:32<span class="w"> </span><span class="m">2024</span><span class="o">]</span>
Error<span class="w"> </span><span class="k">in</span><span class="w"> </span>rule<span class="w"> </span><span class="m">1</span>:
<span class="w">    </span>jobid:<span class="w"> </span><span class="m">0</span>
<span class="w">    </span>input:<span class="w"> </span>my-input.txt
<span class="w">    </span>output:<span class="w"> </span>my-output.txt
<span class="w">    </span>shell:
<span class="w">        </span>sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="s1">&#39;s# dog # parrot &#39;</span><span class="w"> </span>my-input.txt<span class="w"> </span>&gt;<span class="w"> </span>my-output.txt
<span class="w">        </span><span class="o">(</span>one<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>commands<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span>non-zero<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>code<span class="p">;</span><span class="w"> </span>note<span class="w"> </span>that<span class="w"> </span>snakemake<span class="w"> </span>uses<span class="w"> </span>bash<span class="w"> </span>strict<span class="w"> </span>mode!<span class="o">)</span>
</pre></div>
</div>
<p>Note, however, that this does not apply to bash scripts that you execute
in your snakemake pipeline!</p>
<p>Snakemake also includes support for automatically quoting filenames by
using the <code class="docutils literal notranslate"><span class="pre">:q</span></code> modifier to variables: Instead of <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">{input}</span> <span class="pre">|</span> <span class="pre">gzip</span>
<span class="pre">&gt;</span> <span class="pre">{output}</span></code> simply write <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">{input:q}</span> <span class="pre">|</span> <span class="pre">gzip</span> <span class="pre">&gt;</span> <span class="pre">{output:q}</span></code>. This is
the equivalent of <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">&quot;{input}&quot;</span> <span class="pre">|</span> <span class="pre">gzip</span> <span class="pre">&gt;</span> <span class="pre">&quot;{output}&quot;</span></code> but also handles
cases like multiple filenames.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="snakemake.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Using Snakemake on Esrum</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="batching_commands.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Batching commands in bash</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023-2024, CBMR Data Analytics; licensed under CC-BY 4.0
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Writing robust bash scripts</a><ul>
<li><a class="reference internal" href="#improving-default-bash-behavior">Improving default bash behavior</a><ul>
<li><a class="reference internal" href="#prevent-use-of-undefined-variables">Prevent use of undefined variables</a></li>
<li><a class="reference internal" href="#stop-running-on-program-failures">Stop running on program failures</a></li>
<li><a class="reference internal" href="#prevent-bash-from-updating-running-scripts">Prevent bash from updating running scripts</a></li>
<li><a class="reference internal" href="#putting-it-all-together">Putting it all together</a></li>
</ul>
</li>
<li><a class="reference internal" href="#checking-your-scripts-for-common-mistakes">Checking your scripts for common mistakes</a></li>
<li><a class="reference internal" href="#running-commands-in-snakemake">Running commands in Snakemake</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../_static/js/custom.js?v=3a8ddbd3"></script>
    <script src="../_static/js/libgif.js?v=7adcb026"></script>
    <script src="../_static/js/playback.js?v=d7002ce9"></script>
    </body>
</html>